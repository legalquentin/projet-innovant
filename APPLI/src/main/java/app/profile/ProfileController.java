package app;

import org.springframework.http.HttpEntity;
import org.springframework.ui.Model;
import java.util.Arrays;
import java.util.logging.Logger;
import java.util.HashMap;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

@RestController
public class ProfileController {

  @Autowired
  // This means to get the bean called userRepository
  // Which is auto-generated by Spring, we will use it to handle the data
  private UserRepository userRepository;

  private Serializer serializer = new Serializer();
  private static final Logger LOGGER = Logger.getLogger(Thread.currentThread().getStackTrace()[0].getClassName());

  //Profil input/output method
  @RequestMapping(value = "/getProfil", method = RequestMethod.POST, produces = "application/json", consumes = "application/json")
  public String getProfil(@RequestBody JSONObject json, @RequestHeader(value="session-id") String sessionId) {
    try {
      LOGGER.info("/GetProfil requested from : "+(String) json.get("email"));
      if (!serializer.checkToken((String) json.get("email"), sessionId))
      return serializer.CreateResponseBody(403, "Unauthenticated request");
      return getProfile((String) json.get("email"));
    } catch (Exception ex) {
      LOGGER.warning("Exception on /getProfil -- Cause: "+ ex.getMessage());
      Serializer serializer = new Serializer();
      return serializer.CreateResponseBody(400, "Bad Request");
    }
  }

  @RequestMapping(value = "/updateProfil", method = RequestMethod.POST, produces = "application/json", consumes = "application/json")
  public String updateProfil(@RequestBody JSONObject json, @RequestHeader(value="session-id") String sessionId) {
    try {
      LOGGER.info("/UpdateProfil requested from : "+(String) json.get("email"));
      if (!serializer.checkToken((String) json.get("email"), sessionId))
      return serializer.CreateResponseBody(403, "Unauthenticated request");
      return serializer.CreateResponseBody(200, updateProfile((String) json.get("user")));
    } catch (Exception ex) {
      LOGGER.warning("Exception on /updateProfil -- Cause: "+ ex.getMessage());
      Serializer serializer = new Serializer();
      return serializer.CreateResponseBody(400, "Bad Request");
    }
  }

  // public cause we want to recover the user data on the connection too, to avoid
  // doing oto many requets if we can
  public String getProfile(String email) {
    try {
      String user = userRepository.findByEmail(email).getUserJsonString();
      return "{\"status\":200, \"response\":"+user+"}";
    } catch (NullPointerException ex) {
      return "{\"status\":200, \"response\":\"{}\"}";
    }
  }

  public String getProfile(String email, String sessionId) {
    try {
      String user = userRepository.findByEmail(email).getUserJsonString();
      return "{\"status\":200, \"response\":"+user+", \"session-id\":\""+sessionId+"\"}";
    } catch (NullPointerException ex) {
      return "{\"status\":200, \"response\":\"{}\"}";
    }
  }


  // think about that.... What if, and i insist on the 'IF', an authenticated user
  // change his JSONpayload in the javascript request and set the email of another guy ?
  // he then can change the data of another user.
  // Now that's when things are getting tricky, if he has a valid session token, then
  // his request well be accepted no matter what, so we must first figure if his session token
  // correspond to his email ! oohohoho i'm so great sometimes :D

  private String updateProfile(String data) {
    try {
      JSONParser parser = new JSONParser();
      JSONObject obj = (JSONObject) parser.parse(data);
      String email = (String) obj.get("email");
      // think about the token dude !
      User user = userRepository.findByEmail(email);
      user.update(obj);
      userRepository.save(user);
      return "User info Updated";
    } catch(Exception ex) {
      ex.printStackTrace();
      LOGGER.warning("Exception on /updateProfil -- Cause: "+ ex.getMessage());
      return "Error";
    }
  }
}
